pipeline {
    agent any

    environment {
        DOCKERHUB_USER = 'kopu17raj'
        DOCKERHUB_REPO = 'mediman'
        AWS_EC2_IP = '13.235.8.67'
        AWS_EC2_USER = 'ubuntu'
        AWS_SSH_KEY = credentials('mediman-ssh-key')
        RDS_ENDPOINT = 'mediman-db.c3ee42mwac6f.ap-south-1.rds.amazonaws.com'
        DB_PASSWORD = credentials('rds-db-password')
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                    url: 'https://github.com/Kopuraj/SEM-Tracker.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('SEM_full2') {
                    sh '''
                        echo "Building Docker images..."
                        
                        # Build backend with correct path
                        docker build -t ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-backend:latest ./sem-tracker
                        docker build -t ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-backend:${BUILD_NUMBER} ./sem-tracker
                        
                        # Build frontend with correct path
                        docker build -t ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-frontend:latest ./frontend_SEM_track
                        docker build -t ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-frontend:${BUILD_NUMBER} ./frontend_SEM_track
                        
                        echo "‚úÖ Docker images built successfully"
                        docker images | grep ${DOCKERHUB_USER}
                    '''
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKERHUB_CREDENTIALS_USR',
                        passwordVariable: 'DOCKERHUB_CREDENTIALS_PSW'
                    )]) {
                        sh '''
                            echo "Logging in to Docker Hub..."
                            echo ${DOCKERHUB_CREDENTIALS_PSW} | docker login -u ${DOCKERHUB_CREDENTIALS_USR} --password-stdin
                            
                            echo "Pushing images to Docker Hub..."
                            docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-backend:latest
                            docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-backend:${BUILD_NUMBER}
                            docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-frontend:latest
                            docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}-frontend:${BUILD_NUMBER}
                            
                            echo "‚úÖ Docker Hub push completed!"
                        '''
                    }
                }
            }
        }

        stage('Deploy to AWS EC2') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'dockerhub-credentials',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        ),
                        string(credentialsId: 'rds-db-password', variable: 'DB_PASS')
                    ]) {
                        sshagent(["${AWS_SSH_KEY}"]) {
                            sh """
                                echo "Deploying to AWS EC2 at ${AWS_EC2_IP}..."
                                
                                # Create deployment directory and docker-compose file on EC2
                                ssh -o StrictHostKeyChecking=no ${AWS_EC2_USER}@${AWS_EC2_IP} << 'EOF'
                                    echo "=== Starting deployment on EC2 ==="
                                    
                                    # Create project directory if it doesn't exist
                                    mkdir -p ~/mediman
                                    cd ~/mediman
                                    
                                    # Create docker-compose.yml
                                    cat > docker-compose.yml << 'COMPOSE_END'
version: '3.8'

services:
  backend:
    image: kopu17raj/mediman-backend:latest
    container_name: mediman-api
    ports:
      - "8080:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mediman-db.c3ee42mwac6f.ap-south-1.rds.amazonaws.com:3306/mediman?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=DB_PASSWORD_PLACEHOLDER
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT=org.hibernate.dialect.MySQL8Dialect
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
      - SERVER_PORT=8081
    restart: unless-stopped
    networks:
      - mediman-network

  frontend:
    image: kopu17raj/mediman-frontend:latest
    container_name: mediman-frontend
    ports:
      - "80:80"
    restart: unless-stopped
    networks:
      - mediman-network

networks:
  mediman-network:
    driver: bridge
COMPOSE_END

                                    echo "‚úÖ docker-compose.yml created"
EOF

                                # Now replace the placeholder with actual password and deploy
                                ssh -o StrictHostKeyChecking=no ${AWS_EC2_USER}@${AWS_EC2_IP} bash << DEPLOY_END
                                    cd ~/mediman
                                    
                                    # Replace password placeholder
                                    sed -i 's/DB_PASSWORD_PLACEHOLDER/${DB_PASS}/g' docker-compose.yml
                                    
                                    # Login to Docker Hub
                                    echo '${DOCKER_PASS}' | docker login -u '${DOCKER_USER}' --password-stdin
                                    
                                    # Pull latest images
                                    echo "Pulling latest images..."
                                    docker compose pull
                                    
                                    # Stop old containers
                                    echo "Stopping old containers..."
                                    docker compose down
                                    
                                    # Start new containers
                                    echo "Starting new containers..."
                                    docker compose up -d
                                    
                                    # Wait for containers to start
                                    sleep 20
                                    
                                    echo "=== Deployment completed ==="
                                    echo "Containers running:"
                                    docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
DEPLOY_END

                                echo ""
                                echo "‚úÖ Deployment successful!"
                                echo "Frontend: http://${AWS_EC2_IP}"
                                echo "Backend API: http://${AWS_EC2_IP}:8080"
                            """
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    sh """
                        echo "=== Verifying Deployment ==="
                        sleep 10
                        
                        echo "Testing backend health..."
                        BACKEND_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://${AWS_EC2_IP}:8080/actuator/health || echo "000")
                        echo "Backend HTTP Status: \${BACKEND_STATUS}"
                        
                        echo ""
                        echo "Testing frontend..."
                        FRONTEND_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://${AWS_EC2_IP} || echo "000")
                        echo "Frontend HTTP Status: \${FRONTEND_STATUS}"
                    """
                    
                    sshagent(["${AWS_SSH_KEY}"]) {
                        sh """
                            echo ""
                            echo "Checking container logs..."
                            ssh -o StrictHostKeyChecking=no ${AWS_EC2_USER}@${AWS_EC2_IP} << 'EOF'
                                cd ~/mediman
                                echo "=== Container Status ==="
                                docker compose ps
                                
                                echo ""
                                echo "=== Backend Logs (last 20 lines) ==="
                                docker logs mediman-api --tail 20 2>/dev/null || echo "No backend logs available"
                                
                                echo ""
                                echo "=== Frontend Logs (last 10 lines) ==="
                                docker logs mediman-frontend --tail 10 2>/dev/null || echo "No frontend logs available"
EOF
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo '--- Pipeline Execution Finished ---'
            sh '''
                echo "Cleaning up local Docker images..."
                docker image prune -f || true
            '''
        }
        success {
            echo '‚úÖ SEM Tracker deployed successfully to AWS!'
            echo ''
            echo '========================================='
            echo 'üåê Access your application:'
            echo "   Frontend: http://${AWS_EC2_IP}"
            echo "   Backend:  http://${AWS_EC2_IP}:8080"
            echo '========================================='
            echo 'üìä Deployment Details:'
            echo "   Docker Hub: ${DOCKERHUB_USER}"
            echo "   Images: ${DOCKERHUB_REPO}-backend, ${DOCKERHUB_REPO}-frontend"
            echo "   Build Number: ${BUILD_NUMBER}"
            echo "   RDS Database: ${RDS_ENDPOINT}"
            echo '========================================='
        }
        failure {
            echo '‚ùå Pipeline failed!'
            script {
                sshagent(["${AWS_SSH_KEY}"]) {
                    sh """
                        echo "Fetching error logs from EC2..."
                        ssh -o StrictHostKeyChecking=no ${AWS_EC2_USER}@${AWS_EC2_IP} << 'EOF'
                            cd ~/mediman
                            echo "=== Backend Error Logs ==="
                            docker logs mediman-api --tail 100 2>/dev/null || echo "No backend logs"
                            
                            echo ""
                            echo "=== Frontend Error Logs ==="
                            docker logs mediman-frontend --tail 50 2>/dev/null || echo "No frontend logs"
EOF
                    """ 
                }
            }
        }
    }
}
