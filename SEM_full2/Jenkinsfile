pipeline {
    agent any

    environment {
        // REPLACE THESE WITH YOUR ACTUAL VALUES OR CONFIGURE IN JENKINS
        DOCKER_HUB_USER = 'kopu17raj' 
        IMAGE_NAME_BACKEND = 'sem-tracker-backend'
        IMAGE_NAME_FRONTEND = 'sem-tracker-frontend'
        EC2_USER = 'ubuntu' // or ec2-user
        EC2_IP = '65.2.6.115' // User provided EC2 Public IP
        
        // Credentials IDs set in Jenkins
        DOCKER_CREDS_ID = 'docker-hub-credentials'
        SSH_KEY_ID = 'aws-ec2-ssh-key'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    sh "docker build -t ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest ./SEM_full2/sem-tracker"
                    sh "docker build -f ./SEM_full2/frontend_SEM_track/Dockerfile.prod -t ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest ./SEM_full2/frontend_SEM_track"
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh "echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin"
                        sh "docker push ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest"
                        sh "docker push ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest"
                    }
                }
            }
        }

        stage('Deploy to AWS') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: SSH_KEY_ID, keyFileVariable: 'SSH_KEY_FILE')]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no -i \${SSH_KEY_FILE} ${EC2_USER}@${EC2_IP} '
                            # Add Swap Memory (2GB) to prevent OOM freezes on t3.micro
                            if ! swapon --show | grep -q "/swapfile"; then
                                echo "Adding 2GB Swap file..."
                                sudo fallocate -l 2G /swapfile
                                sudo chmod 600 /swapfile
                                sudo mkswap /swapfile
                                sudo swapon /swapfile
                                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                            fi

                            # Update and install Docker if missing
                            if ! command -v docker &> /dev/null; then
                                echo "Docker not found. Installing..."
                                sudo apt-get update
                                sudo apt-get install -y docker.io docker-compose-v2
                                sudo usermod -aG docker ${EC2_USER}
                                # Note: Group membership requires re-login, so we use sudo for now
                            fi

                            # Ensure Docker service is running
                            sudo systemctl start docker
                            sudo systemctl enable docker
                            
                            echo "Docker Version:"
                            sudo docker --version
                            
                            # Pull latest images
                            sudo docker pull ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest
                            sudo docker pull ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest
                            
                            # Stop existing containers
                            sudo docker compose -f /home/${EC2_USER}/docker-compose.prod.yml down --timeout 30 || true
                        '
                    """
                    // Copy docker-compose.prod.yml to server
                    sh "scp -o StrictHostKeyChecking=no -i \${SSH_KEY_FILE} ./SEM_full2/docker-compose.prod.yml ${EC2_USER}@${EC2_IP}:/home/${EC2_USER}/docker-compose.prod.yml"
                    
                    // Now run up
                    sh """
                        ssh -o StrictHostKeyChecking=no -i \${SSH_KEY_FILE} ${EC2_USER}@${EC2_IP} '
                            # Start new containers
                            sudo docker compose -f /home/${EC2_USER}/docker-compose.prod.yml up -d

                            # Wait 10 seconds for startup
                            sleep 10

                            # DEBUG: Check if containers are running
                            echo "=== CONTAINER STATUS ==="
                            sudo docker ps -a

                            # DEBUG: Check memory usage
                            echo "=== MEMORY USAGE ==="
                            free -m

                            # DEBUG: Print last 50 lines of backend logs
                            echo "=== BACKEND LOGS ==="
                            sudo docker logs backend_container_new --tail 50
                        '
                    """
                }
            }
        }
    }

    post {
        always {
            sh 'docker logout'
        }
    }
}
