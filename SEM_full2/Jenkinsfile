pipeline {
    agent any

    environment {
        // REPLACE THESE WITH YOUR ACTUAL VALUES OR CONFIGURE IN JENKINS
        DOCKER_HUB_USER = 'kopuraj' 
        IMAGE_NAME_BACKEND = 'sem-tracker-backend'
        IMAGE_NAME_FRONTEND = 'sem-tracker-frontend'
        EC2_USER = 'ubuntu' // or ec2-user
        EC2_IP = '65.2.6.115' // User provided EC2 Public IP
        
        // Credentials IDs set in Jenkins
        DOCKER_CREDS_ID = 'docker-hub-credentials'
        SSH_KEY_ID = 'aws-ec2-ssh-key'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    sh "docker build -t ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest ./SEM_full2/sem-tracker"
                    sh "docker build -f ./SEM_full2/frontend_SEM_track/Dockerfile.prod -t ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest ./SEM_full2/frontend_SEM_track"
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh "echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin"
                        sh "docker push ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest"
                        sh "docker push ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest"
                    }
                }
            }
        }

        stage('Deploy to AWS') {
            steps {
                sshagent(credentials: [SSH_KEY_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                            # Ensure Docker is installed
                            docker --version
                            
                            # Pull latest images
                            docker pull ${DOCKER_HUB_USER}/${IMAGE_NAME_BACKEND}:latest
                            docker pull ${DOCKER_HUB_USER}/${IMAGE_NAME_FRONTEND}:latest
                            
                            # Stop existing containers
                            docker compose -f docker-compose.prod.yml down || true
                            
                            # Start new containers
                            # NOTE: Assuming docker-compose.prod.yml is on the server. 
                            # If not, we should copy it (scp) first.
                            # For now, let's copy it from the workspace to the server.
                        '
                    """
                    // Copy docker-compose.prod.yml to server
                    sh "scp -o StrictHostKeyChecking=no ./SEM_full2/docker-compose.prod.yml ${EC2_USER}@${EC2_IP}:~/docker-compose.prod.yml"
                    
                    // Now run up
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                            docker compose -f docker-compose.prod.yml up -d
                        '
                    """
                }
            }
        }
    }

    post {
        always {
            sh 'docker logout'
        }
    }
}
